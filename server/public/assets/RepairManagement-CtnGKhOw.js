import{aU as ae,aV as le,O as d,a6 as oe,a5 as ne,_ as re,P as se,q as de,o as F,a as o,w as s,c as ie,k as ue,V,b as y,f as x,e as P,a0 as i,A as Y,a1 as me,d as fe,W as pe,F as ce,$ as f}from"./index-CGGVM91c.js";import{d as I}from"./dayjs.min-BPYrWRgr.js";import{_ as ge,a as _e}from"./UiParentCard.vue_vue_type_script_setup_true_lang-DnD-5gIF.js";import{_ as ye}from"./NewModal-RG6-e5WE.js";import{B as Ce}from"./main-Dfa23GB-.js";import{d as Ve}from"./theme-bootstrap-maRaUoWN.js";const Ae={class:"text-right mt-2"},Me={__name:"RepairManagement",setup(De){var T,M;const u=Ve.useToast();ae.registerModules([le]);const N=me,m=((M=(T=import.meta)==null?void 0:T.env)==null?void 0:M.VITE_API_BASE)||"/api",$=`${m}/process`;let C=new Map,A=new Map;const k=async()=>{const[e,t]=await Promise.all([f.get(`${m}/common/codes/FC`),f.get(`${m}/common/codes/RR`)]),l=S=>(S||[]).reduce((n,r)=>(n.set(String(r.code??r.CODE),r.code_name??r.CODE_NAME),n),new Map);C=l(e.data),A=l(t.data)},p=d(""),g=d(null),U=e=>g.value=e.api,D=e=>{g.value&&(g.value.setFilterModel({공정코드:{filterType:"text",type:"equals",filter:e||""}}),g.value.onFilterChanged())},B=d([{field:"공정코드",hide:!0,filter:"agTextColumnFilter"},{field:"설비코드",flex:1},{field:"설비명",flex:1},{field:"설비유형",flex:1},{field:"설비상태",flex:1,cellStyle:e=>e.value==="가동"?{color:"blue",fontWeight:"bold"}:e.value==="비가동"?{color:"red",fontWeight:"bold"}:null},{field:"비가동사유",flex:1},{field:"고장유형",flex:1},{field:"비가동시작시간",flex:1},{field:"담당자",flex:1}]),O={editable:!1,sortable:!0,resizable:!0},h=async()=>(await f.get(`${m}/facility`)).data||[],W=async()=>(await f.get(`${m}/facility/status`)).data||[],c=d([]),G=e=>e?I(e).format("YYYY-MM-DD HH:mm:ss"):"-",z=(e,t)=>{const l=new Map(t.map(n=>[n.FAC_ID,n]));return e.filter(n=>Number(n.FS_STATUS)===1&&(n.FS_REASON||"")==="고장").map(n=>{const r=l.get(n.FAC_ID)||{},ee=r.FAC_TYPE?C.get(String(r.FAC_TYPE))||r.FAC_TYPE:r.FAC_TYPE_NM||"-",te=n.FS_TYPE?A.get(String(n.FS_TYPE))||n.FS_TYPE:"-";return{공정코드:r.PR_ID||"",설비코드:n.FAC_ID,설비명:n.FAC_NAME||r.FAC_NAME||"",설비유형:ee,설비상태:"비가동",비가동사유:"고장",고장유형:te,비가동시작시간:n.DOWN_STARTDAY?G(n.DOWN_STARTDAY):"-",담당자:(n.MANAGER??r.MANAGER??"").toString()||"-",_fsId:n.FS_ID}})},E=async()=>{try{await k();const[e,t]=await Promise.all([h(),W()]);c.value=z(t,e),p.value&&D(p.value)}catch(e){console.error(e),c.value=[],u.error("초기 로딩 실패",{position:"top-right",duration:1e3})}},a=oe({code:"",name:"",type:"",err:"",manager:"",repairStart:"",repairEnd:"",note:"",remark:"",_fsId:null}),_=d(-1),L=e=>{const t=e.data;_.value=e.rowIndex??-1,a.code=t.설비코드,a.name=t.설비명,a.type=t.설비유형,a.err=t.고장유형,a.manager=t.담당자==="-"?"":t.담당자,a.repairStart=t.비가동시작시간||R(),a.repairEnd="",a.note="",a.remark="",a._fsId=t._fsId||null};ne(()=>a.manager,e=>{_.value>-1&&c.value[_.value]&&(c.value[_.value].담당자=(e||"").trim()||"-")});const q=async()=>{var t;if(!a._fsId){u.error("선택된 비가동 건이 없습니다.",{position:"top-right",duration:1e3});return}if(!((t=a.note)!=null&&t.trim())){u.error("수리내역을 입력해 주세요.",{position:"top-right",duration:1e3});return}const e=a.repairEnd||R();a.repairEnd=e;try{await f.patch(`${m}/facility/status/end`,{FS_ID:a._fsId,endTime:e,restoreStatus:0,checkTime:e,repairContent:a.note,repairNote:a.remark||null,MANAGER:(a.manager||"").trim()||null}),a._fsId=null,await E(),a.code="",u.success("수리 완료 처리되었습니다.",{position:"top-right",duration:1e3})}catch(l){console.error(l),u.error("수리 완료 처리 실패",{position:"top-right",duration:1e3})}};function R(){const e=new Date,t=l=>String(l).padStart(2,"0");return`${e.getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())} ${t(e.getHours())}:${t(e.getMinutes())}:${t(e.getSeconds())}`}const v=d(null),w=d(""),b=d([]),H=d([{field:"공정코드",flex:1},{field:"공정명",flex:1},{field:"설비유형",flex:1},{field:"등록일자",flex:1},{field:"작성자",flex:1},{field:"비고",flex:1}]),j=e=>({공정코드:e.PR_ID??e.PRC_CODE??"",공정명:e.PRC_NAME??"",설비유형:e.FAC_TYPE?C.get(String(e.FAC_TYPE))||e.FAC_TYPE:"-",등록일자:e.PRC_RDATE?I(e.PRC_RDATE).format("YYYY-MM-DD"):"",작성자:e.PRC_WRITER??"",비고:e.PRC_NOTE??""}),Q=async()=>{const{data:e}=await f.get($);return(Array.isArray(e)?e:[]).map(j)},J=async e=>{var t;try{w.value=e,b.value=await Q(),(t=v.value)==null||t.open()}catch(l){console.error("[process list] error:",l),u.error("공정 목록 조회 실패",{position:"top-right",duration:1e3})}},K=e=>{e&&(p.value=e.공정코드||"",D(e.공정코드))};re(E);const X=d({title:"설비 수리관리"}),Z=se([{title:"설비",disabled:!0,href:"#"},{title:"수리 관리",disabled:!1,href:"#"}]);return(e,t)=>(F(),de(ce,null,[o(ge,{title:X.value.title,breadcrumbs:Z.value},null,8,["title","breadcrumbs"]),o(_e,{title:"수리 관리"},{default:s(()=>[o(V,{class:"mb-2 py-0"},{default:s(()=>[o(y,{cols:"12",class:"d-flex align-center"},{default:s(()=>[o(x,{color:"warning",variant:"flat",onClick:t[0]||(t[0]=l=>J("공정 조회"))},{default:s(()=>t[11]||(t[11]=[P("공정 조회")])),_:1})]),_:1})]),_:1}),o(V,{class:"mb-4 pt-0"},{default:s(()=>[o(y,{cols:"12",md:"3"},{default:s(()=>[o(i,{label:"공정코드",modelValue:p.value,"onUpdate:modelValue":t[1]||(t[1]=l=>p.value=l),readonly:"","hide-details":"",density:"comfortable",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),o(Y(Ce),{style:{height:"240px"},theme:Y(N),rowData:c.value,columnDefs:B.value,defaultColDef:O,animateRows:!0,suppressClickEdit:!0,pagination:!0,"pagination-page-size":10,onGridReady:U,onRowClicked:L},null,8,["theme","rowData","columnDefs"]),o(ye,{ref_key:"modalRef",ref:v,title:w.value,rowData:b.value,colDefs:H.value,onConfirm:K},null,8,["title","rowData","colDefs"]),a.code?(F(),ie(pe,{key:0,class:"mt-6 pa-4"},{default:s(()=>[o(V,{dense:""},{default:s(()=>[o(y,{cols:"12",md:"6"},{default:s(()=>[o(i,{label:"설비코드",modelValue:a.code,"onUpdate:modelValue":t[2]||(t[2]=l=>a.code=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"설비명",modelValue:a.name,"onUpdate:modelValue":t[3]||(t[3]=l=>a.name=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"설비유형",modelValue:a.type,"onUpdate:modelValue":t[4]||(t[4]=l=>a.type=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"고장유형",modelValue:a.err,"onUpdate:modelValue":t[5]||(t[5]=l=>a.err=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"수리내역",modelValue:a.note,"onUpdate:modelValue":t[6]||(t[6]=l=>a.note=l),dense:"",outlined:""},null,8,["modelValue"])]),_:1}),o(y,{cols:"12",md:"6"},{default:s(()=>[o(i,{label:"비가동 시작일",modelValue:a.repairStart,"onUpdate:modelValue":t[7]||(t[7]=l=>a.repairStart=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"수리 완료일",modelValue:a.repairEnd,"onUpdate:modelValue":t[8]||(t[8]=l=>a.repairEnd=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"담당자",modelValue:a.manager,"onUpdate:modelValue":t[9]||(t[9]=l=>a.manager=l),dense:"",outlined:""},null,8,["modelValue"]),o(i,{label:"비고",modelValue:a.remark,"onUpdate:modelValue":t[10]||(t[10]=l=>a.remark=l),dense:"",outlined:""},null,8,["modelValue"]),fe("div",Ae,[o(x,{color:"primary",onClick:q},{default:s(()=>t[12]||(t[12]=[P("수리완료")])),_:1})])]),_:1})]),_:1})]),_:1})):ue("",!0)]),_:1})],64))}};export{Me as default};
