import{O as u,P as ke,a6 as Re,_ as Qe,$ as V,y,a5 as ze,q as U,o as q,a as l,w as d,d as r,f as w,e as f,V as Fe,b as c,a0 as p,aH as Ge,aI as Te,A as Q,W as J,S as X,T as ee,Z as te,Y as ae,aJ as _e,F as oe,s as $e,t as h,a8 as Be}from"./index-CGGVM91c.js";import{_ as Ie,a as Me}from"./UiParentCard.vue_vue_type_script_setup_true_lang-DnD-5gIF.js";import{B as z}from"./main-Dfa23GB-.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";const qe={class:"card-headline"},Ae={class:"center-actions-under-form"},Le={class:"main-2col"},Oe={class:"pane"},Ee={class:"pane-head"},He={class:"pane-action"},je={class:"pane right-pane"},Ke={class:"r"},Ze={class:"r"},Ye={class:"r text-red"},b="http://localhost:3000",Je=10,le=3,Xe=10,et={__name:"WorkOrder",setup(tt){const re=u({title:"작업지시 관리"}),de=ke([{title:"생산",disabled:!0,href:"#"},{title:"작업지시 관리",disabled:!1,href:"#"}]),N=u({open:!1,msg:"",color:"primary"}),m=(t,e="primary")=>N.value={open:!0,msg:t,color:e},D=u(!1),A=u([]),o=Re({issueNumber:"",orderDate:"",contact:"",productCode:"",productName:"",dueDate:"",targetQty:10,orderName:"",memo:""});function F(){const t=new Date,e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),s=Math.floor(Math.random()*9e3+1e3);return`WO-${e}${a}${i}-${s}`}Qe(()=>{o.issueNumber||(o.issueNumber=F()),o.orderDate||(o.orderDate=new Date().toISOString().slice(0,10)),L()});const G=u([]),S=u("");async function L(){try{const{data:t}=await V.get(`${b}/products`,{params:{kw:S.value,page:1,size:100}});(t!=null&&t.ok||t!=null&&t.rows)&&(G.value=t.rows||[])}catch(t){console.error(t),m("제품 조회 오류","error")}}const ne=y(()=>{const t=S.value.trim().toLowerCase();return t?G.value.filter(e=>e.code.toLowerCase().includes(t)||e.name.toLowerCase().includes(t)):G.value}),se=y(()=>ne.value);function ie(){L()}const x=u([]),ue=y(()=>x.value);async function P(t,e){x.value=[];const a=String(t||"").trim(),i=Math.max(Number(e||0),0);if(a)try{const{data:s}=await V.get(`${b}/materials/status`,{params:{productCode:a,targetQty:i}}),We=(s==null?void 0:s.rows)||[];x.value=We.map(Y=>({...Y,status:Number(Y.shortage||0)>0?"부족":"가능"}))}catch(s){console.error(s),m("자재현황 조회 오류","error")}}const T=u(null),W=u([]),me=y(()=>W.value);async function O(t){if(T.value=null,W.value=[],!!t)try{const{data:e}=await V.get(`${b}/boms`,{params:{productCode:t}});(e!=null&&e.ok||e!=null&&e.items)&&(T.value=e.header||null,W.value=(e.items||[]).map(a=>({seq:a.seq,matCode:a.matCode,matName:a.matName,matType:a.matType,qty:a.qty,unit:a.unit})))}catch(e){console.error(e),m("BOM 조회 오류","error")}}const C=u(!1),_=u(""),k=u([]);async function ce(){try{const t=_.value.trim(),{data:e}=await V.get(`${b}/plans`,{params:{kw:t,page:1,size:200}});e!=null&&e.ok||e!=null&&e.rows?k.value=e.rows||[]:m("계획서 조회 실패","error")}catch(t){console.error(t),m("계획서 조회 오류","error")}}function pe(){_.value="",C.value=!0,ce()}const fe=y(()=>{const t=_.value.trim().toLowerCase();return t?k.value.filter(e=>e.planNo.toLowerCase().includes(t)||e.productCode.toLowerCase().includes(t)||e.productName.toLowerCase().includes(t)):k.value}),ge=y(()=>fe.value),v=u([]);function he(t){const e=t.api.getSelectedRows();if(e.length===0){v.value=[];return}const a=e[0];e.filter(s=>s.productCode!==a.productCode||s.productType!==a.productType).length&&(t.api.forEachNode(s=>{s.isSelected()&&(s.data.productCode!==a.productCode||s.data.productType!==a.productType)&&s.setSelected(!1)}),m("같은 제품/유형만 복수 선택 가능합니다.","error")),v.value=t.api.getSelectedRows().map(s=>s.id)}function ve(){if(!v.value.length){m("계획서를 선택하세요.","error");return}const t=k.value.filter(i=>v.value.includes(i.id)),e=t[0];o.productCode=e.productCode,o.productName=e.productName,o.dueDate=t.map(i=>i.dueDate).sort()[0],o.targetQty=t.reduce((i,s)=>i+Number(s.totalQty||0),0);const a=t.map(i=>i.planName).filter(Boolean);o.orderName=a.join(", ").slice(0,200),C.value=!1,O(o.productCode),P(o.productCode,o.targetQty)}function ye(t){var a,i;const e=(((i=(a=t.api).getSelectedRows)==null?void 0:i.call(a))??[])[0];e!=null&&e.code&&(o.productCode=e.code,o.productName=e.name,O(o.productCode),P(o.productCode,o.targetQty))}ze([()=>o.productCode,()=>o.targetQty],([t,e])=>{t&&P(t,e)});async function we(){var t;if(o.issueNumber||(o.issueNumber=F()),!o.orderDate||!o.productCode||!o.productName||!o.dueDate||!((t=o.contact)!=null&&t.trim())){m("필수 항목이 비어있습니다. (지시일자, 제품, 납기일자, 작성자)","error");return}if(!o.targetQty||o.targetQty<=0){m("목표수량을 1 이상으로 입력하세요.","error");return}try{const e={form:{issueNumber:o.issueNumber,orderDate:o.orderDate,writer:o.contact,contact:o.contact,productCode:o.productCode,productName:o.productName,dueDate:o.dueDate,targetQty:Number(o.targetQty||0),orderName:o.orderName||null,memo:o.memo||""},selectedPlanIds:v.value},{data:a}=await V.post(`${b}/workorders`,e);a!=null&&a.ok?(m(`작업지시 저장 완료 (ID: ${a.woId}, NO: ${a.woNo})`,"success"),E(),P(o.productCode,o.targetQty)):(Array.isArray(a==null?void 0:a.shortages)&&a.shortages.length&&(A.value=a.shortages,D.value=!0),m((a==null?void 0:a.msg)||"저장 실패","error"))}catch(e){console.error(e),m("저장 중 오류","error")}}function E(){o.issueNumber=F(),o.orderDate=new Date().toISOString().slice(0,10),o.contact="",o.productCode="",o.productName="",o.dueDate="",o.targetQty=10,o.orderName="",o.memo="",v.value=[],T.value=null,W.value=[],x.value=[]}const n={cellStyle:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},tooltipValueGetter:t=>t.value},g={...n,cellClass:"ag-right-aligned-cell",valueFormatter:t=>t.value==null?"":String(t.value)},Ne=[{headerName:"제품코드",field:"code",flex:1.2,minWidth:120,...n},{headerName:"제품명",field:"name",flex:1.8,minWidth:160,...n},{headerName:"유형",field:"type",flex:.8,minWidth:90,...n},{headerName:"단위",field:"uom",flex:.6,minWidth:70,...n},{headerName:"규격",field:"spec",flex:1.2,minWidth:120,...n}],Ce=[{headerName:"자재코드",field:"matCode",flex:1.1,minWidth:110,...n},{headerName:"자재명",field:"matName",flex:1.4,minWidth:120,...n},{headerName:"단위",field:"unit",flex:.6,minWidth:70,...n},{headerName:"BOM(단위당)",field:"bomQty",flex:.8,minWidth:110,...g},{headerName:"필요수량",field:"requiredQty",flex:.8,minWidth:100,...g},{headerName:"가용재고",field:"availableQty",flex:.8,minWidth:100,...g},{headerName:"부족수량",field:"shortage",flex:.8,minWidth:100,...g,cellClassRules:{"ag-cell--danger":t=>Number(t.value||0)>0}},{headerName:"상태",field:"status",width:90,valueFormatter:t=>t.value==="부족"?"부족":"가능",cellClassRules:{"ag-cell--danger":t=>t.value==="부족","ag-cell--ok":t=>t.value!=="부족"}}],Ve=[{headerName:"자재코드",field:"matCode",flex:1.1,minWidth:110,...n},{headerName:"자재명",field:"matName",flex:1.2,minWidth:110,...n},{headerName:"자재유형",field:"matType",flex:.9,minWidth:90,...n},{headerName:"소요수량",field:"qty",flex:.8,minWidth:90,...g},{headerName:"단위",field:"unit",flex:.7,minWidth:80,...n}],be=[{headerName:"",checkboxSelection:!0,headerCheckboxSelection:!0,width:70},{headerName:"순번",valueGetter:"node.rowIndex + 1",width:80,...g},{headerName:"계획번호",field:"planNo",minWidth:140,flex:1,...n},{headerName:"계획명",field:"planName",minWidth:140,flex:1,...n},{headerName:"주문코드",field:"orderNo",minWidth:120,...n},{headerName:"제품코드",field:"productCode",minWidth:120,...n},{headerName:"제품명",field:"productName",minWidth:140,flex:1,...n},{headerName:"유형",field:"productType",width:100,...n},{headerName:"작성일자",field:"createdDate",minWidth:120,...n},{headerName:"작성자",field:"writer",width:100,...n},{headerName:"총수량",field:"totalQty",width:110,...g},{headerName:"납기일자",field:"dueDate",minWidth:120,...n}];let H,j,K,Z;function R(t){t&&t.sizeColumnsToFit()}function De(t){H=t.api,$()}function Se(t){j=t.api,B()}function xe(t){K=t.api,I()}function Pe(t){Z=t.api,M()}function $(){R(H)}function B(){R(j)}function I(){R(K)}function M(){R(Z)}return(t,e)=>(q(),U(oe,null,[l(Ie,{title:re.value.title,breadcrumbs:de.value},null,8,["title","breadcrumbs"]),l(Me,null,{default:d(()=>[r("div",qe,[e[16]||(e[16]=r("h5",{class:"title"},"작업지시 등록",-1)),l(w,{color:"warning",onClick:pe},{default:d(()=>e[15]||(e[15]=[f("계획서 조회")])),_:1})]),l(Fe,{class:"mb-2"},{default:d(()=>[l(c,{cols:"4"},{default:d(()=>[l(p,{label:"지시번호",modelValue:o.issueNumber,"onUpdate:modelValue":e[0]||(e[0]=a=>o.issueNumber=a),readonly:"",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"4"},{default:d(()=>[l(p,{label:"지시일자",modelValue:o.orderDate,"onUpdate:modelValue":e[1]||(e[1]=a=>o.orderDate=a),type:"date",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"4"},{default:d(()=>[l(p,{label:"작성자",modelValue:o.contact,"onUpdate:modelValue":e[2]||(e[2]=a=>o.contact=a),dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"4"},{default:d(()=>[l(p,{label:"제품코드",modelValue:o.productCode,"onUpdate:modelValue":e[3]||(e[3]=a=>o.productCode=a),readonly:"",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"4"},{default:d(()=>[l(p,{label:"납기일자",modelValue:o.dueDate,"onUpdate:modelValue":e[4]||(e[4]=a=>o.dueDate=a),type:"date",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"4"},{default:d(()=>[l(p,{label:"목표수량",modelValue:o.targetQty,"onUpdate:modelValue":e[5]||(e[5]=a=>o.targetQty=a),modelModifiers:{number:!0},type:"number",min:"1",step:"1",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"4"},{default:d(()=>[l(p,{label:"제품명칭",modelValue:o.productName,"onUpdate:modelValue":e[6]||(e[6]=a=>o.productName=a),readonly:"",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"8"},{default:d(()=>[l(p,{label:"지시명(계획명)",modelValue:o.orderName,"onUpdate:modelValue":e[7]||(e[7]=a=>o.orderName=a),modelModifiers:{trim:!0},dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(c,{cols:"12"},{default:d(()=>[l(Ge,{label:"비고",modelValue:o.memo,"onUpdate:modelValue":e[8]||(e[8]=a=>o.memo=a),modelModifiers:{trim:!0},rows:"2","auto-grow":"",dense:"",variant:"outlined",class:"text-right"},null,8,["modelValue"])]),_:1})]),_:1}),r("div",Ae,[l(w,{variant:"flat",color:"error",onClick:E},{default:d(()=>e[17]||(e[17]=[f("초기화")])),_:1}),l(w,{color:"primary",onClick:we},{default:d(()=>e[18]||(e[18]=[f("작업지시 등록")])),_:1})]),r("div",Le,[r("section",Oe,[r("div",Ee,[e[19]||(e[19]=r("h5",{class:"pane-title"},"제품목록",-1)),r("div",He,[l(p,{modelValue:S.value,"onUpdate:modelValue":e[9]||(e[9]=a=>S.value=a),modelModifiers:{trim:!0},placeholder:"제품코드/명 검색","hide-details":"",density:"compact",variant:"outlined",style:{"max-width":"420px","min-width":"360px",width:"100%"},onKeyup:Te(ie,["enter"])},null,8,["modelValue"])])]),l(Q(z),{class:"ag-theme-quartz ag-no-wrap",rowData:se.value,columnDefs:Ne,pagination:!0,paginationPageSize:Je,suppressPaginationPanel:!1,domLayout:"autoHeight",rowSelection:"single",onGridReady:De,onFirstDataRendered:$,onGridSizeChanged:$,onRowSelected:ye},null,8,["rowData"])]),r("section",je,[e[20]||(e[20]=r("div",{class:"pane-head"},[r("h5",{class:"pane-title"},"자재현황")],-1)),l(Q(z),{class:"ag-theme-quartz ag-no-wrap",rowData:ue.value,columnDefs:Ce,pagination:!0,paginationPageSize:le,suppressPaginationPanel:!1,domLayout:"autoHeight",onGridReady:Se,onFirstDataRendered:B,onGridSizeChanged:B},null,8,["rowData"]),e[21]||(e[21]=r("div",{class:"pane-head mt-6"},[r("h5",{class:"pane-title"},"BOM목록")],-1)),l(Q(z),{class:"ag-theme-quartz ag-no-wrap bom-grid",rowData:me.value,columnDefs:Ve,pagination:!0,paginationPageSize:le,suppressPaginationPanel:!1,domLayout:"autoHeight",onGridReady:xe,onFirstDataRendered:I,onGridSizeChanged:I},null,8,["rowData"])])])]),_:1}),l(ae,{modelValue:C.value,"onUpdate:modelValue":e[11]||(e[11]=a=>C.value=a),width:"90vw"},{default:d(()=>[l(J,{class:"plan-card"},{default:d(()=>[l(X,{class:"d-flex align-center justify-space-between"},{default:d(()=>e[22]||(e[22]=[r("span",null,"계획서 목록",-1)])),_:1}),l(ee,{class:"dialog-body"},{default:d(()=>[l(Q(z),{class:"ag-theme-quartz ag-no-wrap",rowData:ge.value,columnDefs:be,pagination:!0,paginationPageSize:Xe,rowSelection:"multiple",rowMultiSelectWithClick:!0,suppressRowClickSelection:!0,domLayout:"autoHeight",onGridReady:Pe,onFirstDataRendered:M,onGridSizeChanged:M,onSelectionChanged:he},null,8,["rowData"])]),_:1}),l(te,{class:"justify-end"},{default:d(()=>[l(w,{variant:"flat",color:"darkText",onClick:e[10]||(e[10]=a=>C.value=!1)},{default:d(()=>e[23]||(e[23]=[f("닫기")])),_:1}),l(w,{variant:"flat",color:"success",onClick:ve},{default:d(()=>e[24]||(e[24]=[f("등록")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(ae,{modelValue:D.value,"onUpdate:modelValue":e[13]||(e[13]=a=>D.value=a),"max-width":"720"},{default:d(()=>[l(J,null,{default:d(()=>[l(X,null,{default:d(()=>e[25]||(e[25]=[f("자재 부족으로 지시등록 중단")])),_:1}),l(ee,null,{default:d(()=>[e[27]||(e[27]=r("p",{class:"mb-2"},"아래 자재는 가용재고가 부족합니다. 재고 보충 후 다시 시도하세요.",-1)),l(_e,{density:"compact"},{default:d(()=>[e[26]||(e[26]=r("thead",null,[r("tr",null,[r("th",null,"자재코드"),r("th",null,"자재명"),r("th",{class:"r"},"필요"),r("th",{class:"r"},"가용"),r("th",{class:"r"},"부족"),r("th",null,"단위")])],-1)),r("tbody",null,[(q(!0),U(oe,null,$e(A.value,a=>(q(),U("tr",{key:a.matCode},[r("td",null,h(a.matCode),1),r("td",null,h(a.matName),1),r("td",Ke,h(a.requiredQty),1),r("td",Ze,h(a.availableQty),1),r("td",Ye,h(a.shortage),1),r("td",null,h(a.unit),1)]))),128))])]),_:1})]),_:1}),l(te,{class:"justify-end"},{default:d(()=>[l(w,{onClick:e[12]||(e[12]=a=>D.value=!1)},{default:d(()=>e[28]||(e[28]=[f("확인")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Be,{modelValue:N.value.open,"onUpdate:modelValue":e[14]||(e[14]=a=>N.value.open=a),color:N.value.color,timeout:2e3},{default:d(()=>[f(h(N.value.msg),1)]),_:1},8,["modelValue","color"])],64))}},dt=Ue(et,[["__scopeId","data-v-a19eb9cc"]]);export{dt as default};
