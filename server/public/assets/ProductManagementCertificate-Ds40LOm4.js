import{aU as Y,aY as z,aZ as L,O as r,P as j,y as H,_ as U,a_ as K,q as J,o as Z,a as l,w as o,a$ as X,V as E,f as x,e as v,A as _,a1 as ee,b as te,d as y,j as ae,t as C,b0 as le,W as re,S as oe,T as se,aH as ie,F as de,$ as P,H as ne}from"./index-CGGVM91c.js";import{_ as ue,a as ce}from"./UiParentCard.vue_vue_type_script_setup_true_lang-DnD-5gIF.js";import{B as V}from"./main-Dfa23GB-.js";import{d as pe}from"./theme-bootstrap-maRaUoWN.js";import{_ as fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me={class:"d-flex align-center"},he={class:"ml-auto text-caption"},ve={__name:"ProductManagementCertificate",setup(_e){const g=pe.useToast();Y.registerModules([z,L]);const D=ee,i=K(),S=ne(),O=r({title:"제품 검수관리 등록"}),A=r([{title:"품질",disabled:!0,href:"#"},{title:"제품 검수관리 등록",disabled:!1,href:"#"}]),N=r([{_id:"moisture",label:"함수율",allow:"수분 함량 12~15% (KS범위)",value:""},{_id:"dimension",label:"치수정밀도",allow:"입고자재 ±2mm 이내",value:""},{_id:"strength",label:"강도/내구성",allow:"횡강도 35MPa 이상",value:""},{_id:"stability",label:"안정성",allow:"전도 없음, 전기부 안전, 모서리 등금 위험요소 없음",value:""},{_id:"defects",label:"외관 결점",allow:"옹이, 할렬, 긁힘 육안확인 시 결점이 없을 시",value:""},{_id:"formaldehyde",label:"포름알데히드 방출률",allow:"친환경 E0 등급(0.3mg/L)이하",value:""},{_id:"surface",label:"표면 마감/도장",allow:"도막 들뜸·박리 없음, 균일한 색상·광택 유지",value:""}]),m=j(null),R=r({resizable:!0,minWidth:120,sortable:!1}),I=r("multiple"),M=r([{headerName:"검사명",field:"label",minWidth:160,flex:1},{headerName:"허용수치",field:"allow",minWidth:360,flex:2},{headerName:"측정값",field:"value",minWidth:360,flex:2,editable:!0},{headerName:"판정",colId:"result",minWidth:120,maxWidth:140,valueGetter:e=>{var t;return(t=e.node)!=null&&t.isSelected()?"합격":"불합격"},cellClass:e=>e.value=="합격"?"ag-cell-success":"ag-cell-error",sortable:!1},{headerName:"선택",checkboxSelection:!0,headerCheckboxSelection:!0,width:80,pinned:"right",suppressMenu:!0,sortable:!1,filter:!1}]),q=r({defaultColDef:R.value,rowSelection:"multiple",suppressRowClickSelection:!0,getRowId:e=>e.data._id}),c=r(0),p=r(0),d=H(()=>p.value===c.value?"합격":"불합격");function F(e){m.value=e.api,console.log("AG-Grid 준비 완료")}function k(e){try{e.api.selectAll(),w()}catch(t){console.error("전체 선택 오류:",t)}}function w(){const e=m.value;if(e)try{c.value=e.getDisplayedRowCount(),p.value=e.getSelectedNodes().length,e.refreshCells({columns:["result"],force:!0}),console.log(`재계산 완료: ${p.value}/${c.value}, 상태: ${d.value}`)}catch(t){console.error("재계산 오류:",t)}}const b=r([{certid:"(자동생성)",tpId:0,prdCode:"",prdName:"",prdType:"",totalQty:0,writer:"",finished_at:"",certDate:""}]),Q=r([{headerName:"제품검사번호",field:"certid",width:170,editable:!1},{headerName:"제품코드",field:"prdCode",width:140,editable:!1},{headerName:"제품명",field:"prdName",width:150,editable:!1},{headerName:"제품유형",field:"prdType",width:150,editable:!1},{headerName:"총수량",field:"totalQty",width:110,editable:!1,valueParser:W},{headerName:"작업자",field:"writer",width:120,editable:!1},{headerName:"생산완료일자",field:"finished_at",width:140,editable:!1},{headerName:"검사완료일자",field:"certDate",width:140,editable:!1}]);function W(e){const t=Number(String(e.newValue).replace(/,/g,"").trim());return Number.isFinite(t)?t:e.oldValue}const B=r({defaultColDef:{resizable:!0,minWidth:110},autoSizeStrategy:{type:"fitGridWidth"}}),f=r({description:""});function $(){try{const e=m.value;e&&(e.selectAll(),w()),f.value.description="",N.value.forEach(t=>{t.value=""}),console.log("폼이 초기화되었습니다. (전체 합격 상태)")}catch(e){console.error("초기화 오류:",e)}}async function G(){var e,t;try{const a=b.value[0],n=d.value==="합격";if(console.log("[saveForm] 시작 - 상태:",d.value,"isPass:",n),console.log("[saveForm] 선택된 항목 수:",p.value,"/",c.value),!n&&!f.value.description.trim()){g.error("불합격 사유를 입력해주세요.",{position:"top-right",duration:1e3});return}const T=m.value,h=[];if(T&&T.forEachNode(s=>{const u=s.data;h.push({stdName:u.label,allowedItem:u.allow,measuredValue:String(u.value??""),status:s.isSelected()?"합격":"불합격"})}),console.log("[saveForm] 검사 결과:",h),n){const s={TP_ID:a.tpId,PRD_CODE:a.prdCode,PRD_NAME:a.prdName,PRD_TYPE:a.prdType,TOTAL_QTY:a.totalQty,Q_CHECKED_DATE:a.certDate,CREATED_BY:a.writer,RESULTS:h};console.log("[saveForm] POST /passprd",s),(await P.post("http://localhost:3000/passprd",s)).data.ok&&(g.info("합격 제품이 등록되었습니다",{position:"top-right",duration:1e3}),S.push("/qm/prdmng"))}else{const s={TP_ID:a.tpId,PRD_CODE:a.prdCode,PRD_NAME:a.prdName,PRD_TYPE:a.prdType,TOTAL_QTY:a.totalQty,Q_CHECKED_DATE:a.certDate,CREATED_BY:a.writer,RJT_REASON:f.value.description.trim(),RESULTS:h};console.log("[saveForm] POST /rejectprd",s);const u=await P.post("http://localhost:3000/rejectprd",s);u.data.ok&&(g.info("불합격 제품이 등록되었습니다",{position:"top-right",duration:1e3}),console.log("등록된 인증서 ID:",u.data.prdCertId),S.push("/qm/prdmng"))}}catch(a){console.error("[saveForm] ERROR:",a);let n="등록 중 오류가 발생했습니다.";(t=(e=a.response)==null?void 0:e.data)!=null&&t.message?n=a.response.data.message:a.message&&(n=a.message),alert(n)}}return U(()=>{try{const e=b.value[0];e.tpId=Number(i.query.wo_no||0),e.prdCode=String(i.query.product_code||""),e.prdName=String(i.query.product_name||""),e.prdType=String(i.query.product_type||""),e.totalQty=Number(i.query.qty||0),e.writer=String(i.query.writer||""),e.finished_at=String(i.query.finished_at||""),e.certDate=new Date().toISOString().slice(0,10),console.log("초기 데이터 로드 완료:",e)}catch(e){console.error("초기 데이터 로드 오류:",e)}}),(e,t)=>(Z(),J(de,null,[l(ue,{title:O.value.title,breadcrumbs:A.value},null,8,["title","breadcrumbs"]),l(ce,null,{default:o(()=>[l(E,{justify:"end",class:"mb-2"},{default:o(()=>[l(x,{color:"error",class:"top_btn_ser",variant:"elevated",onClick:$},{default:o(()=>t[1]||(t[1]=[v("초기화")])),_:1}),l(x,{color:"primary",class:"top_btn_ser",onClick:G},{default:o(()=>t[2]||(t[2]=[v("등록")])),_:1})]),_:1}),l(_(V),{rowData:N.value,columnDefs:M.value,defaultColDef:R.value,rowSelection:I.value,gridOptions:q.value,theme:_(D),style:{height:"280px",width:"100%"},onGridReady:F,onFirstDataRendered:k,onSelectionChanged:w},null,8,["rowData","columnDefs","defaultColDef","rowSelection","gridOptions","theme"]),l(E,{class:"my-4"},{default:o(()=>[l(te,{cols:"12",class:"py-1"},{default:o(()=>[y("div",me,[t[3]||(t[3]=y("h5",{class:"mr-4"},"최종처리",-1)),l(ae,{color:d.value==="합격"?"primary":"error"},{default:o(()=>[v(C(d.value),1)]),_:1},8,["color"]),y("span",he,"선택 "+C(p.value)+"/"+C(c.value),1)])]),_:1})]),_:1}),X(l(re,{class:"mb-4",elevation:"2"},{default:o(()=>[l(oe,{class:"bg-red-lighten-5 text-red-darken-2"},{default:o(()=>t[4]||(t[4]=[v("불합격 사유")])),_:1}),l(se,null,{default:o(()=>[l(ie,{modelValue:f.value.description,"onUpdate:modelValue":t[0]||(t[0]=a=>f.value.description=a),label:"불합격 사유",variant:"outlined",rows:"3",counter:"500",maxlength:"500",rules:[a=>d.value==="합격"||a&&a.length>0||"불합격 시 사유는 필수입니다."]},null,8,["modelValue","rules"])]),_:1})]),_:1},512),[[le,d.value==="불합격"]]),l(_(V),{rowData:b.value,columnDefs:Q.value,gridOptions:B.value,theme:_(D),style:{height:"160px",width:"100%"}},null,8,["rowData","columnDefs","gridOptions","theme"])]),_:1})],64))}},De=fe(ve,[["__scopeId","data-v-b1a2fe12"]]);export{De as default};
