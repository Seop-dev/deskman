import{aU as le,aV as oe,O as n,P as se,y as A,a5 as ne,_ as ie,q as M,o as N,a as r,w as c,d as D,k as re,V as k,b as T,a2 as de,f as _,e as b,A as w,a1 as ue,E as $,F as ce,$ as L,a7 as V}from"./index-CGGVM91c.js";import{_ as pe,a as fe}from"./UiParentCard.vue_vue_type_script_setup_true_lang-DnD-5gIF.js";import{B as O}from"./main-Dfa23GB-.js";import{d as ge}from"./theme-bootstrap-maRaUoWN.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me={class:"grid-wrap"},ye={key:0,class:"grid-wrap",style:{"margin-top":"12px"}},we={__name:"QualityStandardManagement",setup(he){const p=ge.useToast();le.registerModules([oe]);const x=ue,B=n({title:"품질 기준 관리"}),I=se([{title:"품질",disabled:!0,href:"#"},{title:"품질 기준 관리",disabled:!1,href:"#"}]),R=n([]),h=n([]),f=n({}),y=n(new Map),q=(e,t)=>`${e}|||${t}`,g=n({type:""}),G=n([{field:"기준",flex:.9,headerName:"기준",editable:!1},{field:"허용수치",flex:1.3,headerName:"허용수치",editable:!1}]),S=n({resizable:!0,sortable:!0}),U=n({defaultColDef:S.value,getRowId:e=>e.data._id,deltaRowDataMode:!0}),F=n([{field:"기준",flex:.9,headerName:"기준",editable:!0},{field:"허용수치",flex:1.3,headerName:"허용수치",editable:!0}]),z=n({resizable:!0,sortable:!1,filter:!1}),P=A(()=>{const e=g.value.type;return e?f.value[e]||[]:[]});let v=null;const Q=e=>{v=e.api,V(()=>{e.api.getDisplayedRowCount()>0&&e.api.selectIndex(0)})},l=n(null),d=n(null),W=e=>{const t=e.api.getSelectedRows();t.length>0?(l.value={...t[0]},d.value={...t[0]}):(l.value=null,d.value=null)},j=A(()=>l.value?[l.value]:[]);let C=null;const K=e=>{C=e.api},Y=e=>{const t=e.colDef.field,a=e.newValue;console.log(`Detail cell changed: ${t} = ${a}`),l.value&&(l.value={...l.value,[t]:a})},H=e=>{const t=e.colDef.field,a=e.newValue;console.log("Cell editing stopped:",t,a),l.value&&a!==void 0&&(l.value={...l.value,[t]:a})},J=()=>{v&&v.refreshCells()},X=e=>{e&&(e.preventDefault(),e.stopPropagation()),setTimeout(()=>{Z()},10)},Z=async()=>{try{if(C&&(C.stopEditing(),await new Promise(m=>setTimeout(m,50))),!l.value||!d.value){p.warning("선택된 항목이 없습니다.",{position:"top-right",duration:1e3});return}const e=g.value.type,t=f.value[e]||[],a=t.findIndex(m=>m._id===d.value._id);if(a===-1){p.warning("해당 데이터를 찾을 수 없습니다",{position:"top-right",duration:1e3});return}const o={...d.value},i={...l.value},s=[...t];s[a]=i,f.value={...f.value,[e]:s},d.value={...i};const u=q(e,o.기준);y.value.set(u,{TYPE:e,STD_NAME:i.기준,ALLOWED_VALUE:i.허용수치,ORIGINAL_STD_NAME:o.기준}),console.log("Applied changes:",{before:o,after:i,pendingUpdate:y.value.get(u)}),p.info("상단에 반영되었습니다. 등록 버튼을 눌러 저장하세요",{position:"top-right",duration:1e3}),await V()}catch(e){console.error("Apply changes error:",e),p.error("변경사항 반영 중 오류가 발생했습니다.",{position:"top-right",duration:2e3})}},ee=async()=>{var t,a;const e=Array.from(y.value.values());if(e.length===0){p.warning("저장할 변경사항이 없습니다",{position:"top-right",duration:1e3});return}try{console.log("Saving updates:",e);for(const o of e){console.log("Sending payload:",o);const i=await L.post("http://localhost:3000/qstdupdate",o);console.log("Server response:",i.data)}y.value.clear(),p.success("변경사항이 저장되었습니다",{position:"top-right",duration:1e3}),await E()}catch(o){console.error("저장 실패:",o),p.error("저장 중 오류가 발생했습니다: "+(((a=(t=o.response)==null?void 0:t.data)==null?void 0:a.message)||o.message),{position:"top-right",duration:3e3})}},te=()=>{d.value&&(l.value={...d.value})};ne(()=>g.value.type,()=>{l.value=null,d.value=null,v&&V(()=>{v.getDisplayedRowCount()>0&&v.selectIndex(0)})});const E=async()=>{try{const e="http://localhost:3000/qstdlist",{data:t}=await L.get(e);console.log("Received data:",t);const a=(t||[]).map(s=>{const u=s.std_type??s.CODE_NAME??s.code_name,m=s.STD_NAME,ae=s.ALLOWED_VALUE;return{_id:`${u}|${m}`,type:u,기준:m,허용수치:ae}});R.value=a;const o=[...new Set(a.map(s=>s.type).filter(Boolean))];h.value=o,!g.value.type&&o.length>0&&(g.value.type=o[0]);const i={};for(const s of a){const u=s.type||"기타";i[u]||(i[u]=[]),i[u].push(s)}f.value=i,console.log("Grouped data:",f.value)}catch(e){console.error("/qstdlist 조회 실패:",e),R.value=[],h.value=[],f.value={}}};return ie(()=>{E()}),(e,t)=>(N(),M(ce,null,[r(pe,{title:B.value.title,breadcrumbs:I.value},null,8,["title","breadcrumbs"]),r(fe,null,{default:c(()=>[r(k,null,{default:c(()=>[r(T,{cols:"3"},{default:c(()=>[r(de,{modelValue:g.value.type,"onUpdate:modelValue":t[0]||(t[0]=a=>g.value.type=a),items:h.value,label:"제품 구분",density:"compact",clearable:""},null,8,["modelValue","items"])]),_:1}),r(T,{cols:"auto",class:"d-flex justify-end"},{default:c(()=>[r(_,{class:"ml-2",color:"primary",onClick:ee},{default:c(()=>t[1]||(t[1]=[b("등록")])),_:1})]),_:1})]),_:1}),D("div",me,[r(w(O),{theme:w(x),style:{height:"420px",width:"100%"},columnDefs:G.value,rowData:P.value,defaultColDef:S.value,gridOptions:U.value,rowSelection:"single",suppressRowClickSelection:!1,onGridReady:Q,onSelectionChanged:W,onCellValueChanged:J},null,8,["theme","columnDefs","rowData","defaultColDef","gridOptions"])]),t[5]||(t[5]=D("br",null,null,-1)),l.value?(N(),M("div",ye,[t[4]||(t[4]=D("div",{style:{padding:"10px","background-color":"#f5f5f5","font-weight":"bold"}},"선택한 기준",-1)),r(k,{justify:"end",class:"mb-2 pa-2"},{default:c(()=>[r(_,{color:"error",class:"top_btn_ser",variant:"elevated",onClick:$(te,["stop"])},{default:c(()=>t[2]||(t[2]=[b("입력초기화")])),_:1}),r(_,{color:"primary",class:"top_btn_ser",onClick:$(X,["stop"])},{default:c(()=>t[3]||(t[3]=[b("상단에 반영")])),_:1})]),_:1}),r(w(O),{style:{height:"120px"},theme:w(x),rowData:j.value,columnDefs:F.value,defaultColDef:z.value,singleClickEdit:!0,stopEditingWhenCellsLoseFocus:!0,onGridReady:K,onCellValueChanged:Y,onCellEditingStopped:H},null,8,["theme","rowData","columnDefs","defaultColDef"])])):re("",!0)]),_:1})],64))}},Re=ve(we,[["__scopeId","data-v-6df227bd"]]);export{Re as default};
