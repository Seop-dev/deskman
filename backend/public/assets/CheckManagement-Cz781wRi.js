import{aU as te,aV as le,O as i,P as oe,a6 as ae,_ as ne,q as se,o as P,a as o,w as s,c as de,k as ie,V,b as A,f as M,e as y,a0 as d,A as N,a1 as re,d as D,aT as ue,a3 as fe,a4 as I,W as me,F as pe,$ as c}from"./index-CGGVM91c.js";import{d as b}from"./dayjs.min-BPYrWRgr.js";import{_ as ce,a as Ae}from"./UiParentCard.vue_vue_type_script_setup_true_lang-DnD-5gIF.js";import{_ as ge}from"./NewModal-RG6-e5WE.js";import{B as Ce}from"./main-Dfa23GB-.js";import{d as _e}from"./theme-bootstrap-maRaUoWN.js";const Ve={class:"mt-2"},ye={class:"text-right mt-6"},Fe={__name:"CheckManagement",setup(De){var F,S;const r=_e.useToast();te.registerModules([le]);const Y=re,k=i({title:"설비 점검관리"}),O=oe([{title:"설비",disabled:!0,href:"#"},{title:"점검 관리",disabled:!1,href:"#"}]),f=((S=(F=import.meta)==null?void 0:F.env)==null?void 0:S.VITE_API_BASE)||"/api",U=`${f}/facility/inspection/complete`,$=`${f}/process`;let g=new Map;const B=async()=>{const{data:t}=await c.get(`${f}/common/codes/FC`);g=new Map(t.map(e=>[String(e.code??e.CODE),e.code_name??e.CODE_NAME]))},m=i(""),p=i(null),H=t=>{p.value=t.api,_()},R=t=>{p.value&&(p.value.setFilterModel({공정코드:{filterType:"text",type:"equals",filter:t||""}}),p.value.onFilterChanged())},W=i([{field:"공정코드",hide:!0,filter:"agTextColumnFilter"},{field:"설비코드",flex:1},{field:"설비명",flex:1},{field:"설비유형",flex:1},{field:"설비상태",flex:1,cellStyle:t=>t.value==="점검"?{color:"red",fontWeight:"bold"}:{color:"blue",fontWeight:"bold"}},{field:"비가동사유",flex:1},{field:"비가동시작시간",flex:1},{field:"적합여부",flex:1,hide:!0},{field:"다음점검일",flex:1,hide:!0},{field:"담당자",flex:1}]),h={editable:!1,sortable:!0,resizable:!0},G=async()=>(await c.get(`${f}/facility`)).data||[],L=async()=>(await c.get(`${f}/facility/status`)).data||[],C=i([]),x=t=>t?b(t).format("YYYY-MM-DD HH:mm:ss"):"-",z=(t,e)=>{const a=new Map(e.map(n=>[n.FAC_ID,n]));return t.filter(n=>Number(n.FS_STATUS)===1&&(n.FS_REASON||"")==="점검").map(n=>{const u=a.get(n.FAC_ID)||{},ee=u.FAC_TYPE?g.get(String(u.FAC_TYPE))||u.FAC_TYPE:u.FAC_TYPE_NM||"-";return{공정코드:u.PR_ID||"",설비코드:n.FAC_ID,설비명:u.FAC_NAME||"",설비유형:ee,설비상태:"점검",비가동사유:n.FS_REASON||"점검",비가동시작시간:n.DOWN_STARTDAY?x(n.DOWN_STARTDAY):n.FS_CHECKDAY?x(n.FS_CHECKDAY):"",적합여부:"-",다음점검일:n.FS_NEXTDAY?String(n.FS_NEXTDAY).slice(0,10):"-",담당자:n.MANAGER??u.MANAGER??"-",_fsId:n.FS_ID}})},_=async()=>{try{await B();const[t,e]=await Promise.all([G(),L()]);C.value=z(e,t),m.value&&R(m.value)}catch(t){console.error(t),C.value=[],r.error("초기 로딩 실패",{position:"top-right",duration:1e3})}},l=ae({code:"",name:"",type:"",manager:"",downStart:"",doneAt:"",nextAt:"",inspectNote:"",fit:"",ngReason:"",_fsId:null}),j=t=>{const e=t.data;Object.assign(l,{code:e.설비코드,name:e.설비명,type:e.설비유형,manager:e.담당자==="-"?"":e.담당자,downStart:e.비가동시작시간||E(),doneAt:"",nextAt:e.다음점검일==="-"?"":e.다음점검일,inspectNote:"",fit:"",ngReason:"",_fsId:e._fsId})},q=async()=>{var t;if(!l._fsId){r.error("설비를 먼저 선택하세요.",{position:"top-right",duration:1e3});return}if(!l.fit){r.error("적합 여부를 선택하세요.",{position:"top-right",duration:1e3});return}if(l.fit==="부적합"&&!l.ngReason.trim()){r.error("부적합 사유를 입력하세요.",{position:"top-right",duration:1e3});return}l.doneAt=E();try{await c.post(U,{FS_ID:l._fsId,FAC_ID:l.code,fit:l.fit,ngReason:l.fit==="부적합"?l.ngReason:null,content:l.inspectNote||null,nextAt:l.nextAt||null,doneAt:l.doneAt,manager:l.manager||null}),await _(),(t=p.value)==null||t.refreshCells({force:!0}),r.success("점검이 완료되었습니다.",{position:"top-right",duration:1e3}),Object.assign(l,{code:"",name:"",type:"",manager:"",downStart:"",doneAt:"",nextAt:"",inspectNote:"",fit:"",ngReason:"",_fsId:null})}catch(e){console.error("[inspection complete] error:",e),r.error("점검 완료 처리 중 오류가 발생했습니다.",{position:"top-right",duration:1e3})}};function E(){return b().format("YYYY-MM-DD HH:mm:ss")}const v=i(null),w=i(""),T=i([]),K=i([{field:"공정코드",flex:1},{field:"공정명",flex:1},{field:"설비유형",flex:1},{field:"등록일자",flex:1},{field:"작성자",flex:1},{field:"비고",flex:1}]),X=t=>({공정코드:t.PR_ID??t.PRC_CODE??"",공정명:t.PRC_NAME??"",설비유형:t.FAC_TYPE?g.get(String(t.FAC_TYPE))||t.FAC_TYPE:"-",등록일자:t.PRC_RDATE?b(t.PRC_RDATE).format("YYYY-MM-DD"):"",작성자:t.PRC_WRITER??"",비고:t.PRC_NOTE??""}),Q=async()=>{const{data:t}=await c.get($);return(Array.isArray(t)?t:[]).map(X)},J=async t=>{var e;try{w.value=t,T.value=await Q(),(e=v.value)==null||e.open()}catch(a){console.error("[process list] error:",a),r.error("공정 목록 조회 실패",{position:"top-right",duration:1e3})}},Z=t=>{t&&(m.value=t.공정코드||"",R(t.공정코드))};return ne(_),(t,e)=>(P(),se(pe,null,[o(ce,{title:k.value.title,breadcrumbs:O.value},null,8,["title","breadcrumbs"]),o(Ae,{title:"설비 점검관리"},{default:s(()=>[o(V,{class:"mb-2 py-0"},{default:s(()=>[o(A,{cols:"12",class:"d-flex align-center"},{default:s(()=>[o(M,{color:"warning",variant:"flat",onClick:e[0]||(e[0]=a=>J("공정 조회"))},{default:s(()=>e[12]||(e[12]=[y("공정 조회")])),_:1})]),_:1})]),_:1}),o(V,{class:"mb-4 pt-0"},{default:s(()=>[o(A,{cols:"12",md:"3"},{default:s(()=>[o(d,{label:"공정코드",modelValue:m.value,"onUpdate:modelValue":e[1]||(e[1]=a=>m.value=a),readonly:"","hide-details":"",density:"comfortable",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),o(N(Ce),{style:{height:"260px"},theme:N(Y),rowData:C.value,columnDefs:W.value,defaultColDef:h,animateRows:!0,suppressClickEdit:!0,pagination:!0,"pagination-page-size":10,onGridReady:H,onRowClicked:j},null,8,["theme","rowData","columnDefs"]),o(ge,{ref_key:"modalRef",ref:v,title:w.value,rowData:T.value,colDefs:K.value,onConfirm:Z},null,8,["title","rowData","colDefs"]),l.code?(P(),de(me,{key:0,class:"mt-6 pa-4 rounded-xl elevation-1 checker-card"},{default:s(()=>[e[15]||(e[15]=D("h3",null,"점검 처리 입력",-1)),o(V,{dense:""},{default:s(()=>[o(A,{cols:"12",md:"6"},{default:s(()=>[o(d,{label:"설비코드",modelValue:l.code,"onUpdate:modelValue":e[2]||(e[2]=a=>l.code=a),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(d,{label:"설비명",modelValue:l.name,"onUpdate:modelValue":e[3]||(e[3]=a=>l.name=a),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(d,{label:"설비유형",modelValue:l.type,"onUpdate:modelValue":e[4]||(e[4]=a=>l.type=a),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(d,{label:"점검내역",modelValue:l.inspectNote,"onUpdate:modelValue":e[5]||(e[5]=a=>l.inspectNote=a),dense:"",outlined:""},null,8,["modelValue"]),o(d,{label:"담당자",modelValue:l.manager,"onUpdate:modelValue":e[6]||(e[6]=a=>l.manager=a),dense:"",outlined:""},null,8,["modelValue"]),o(d,{label:"부적합 사유",modelValue:l.ngReason,"onUpdate:modelValue":e[7]||(e[7]=a=>l.ngReason=a),dense:"",outlined:"",disabled:l.fit!=="부적합"},null,8,["modelValue","disabled"])]),_:1}),o(A,{cols:"12",md:"6"},{default:s(()=>[o(d,{label:"비가동 시작일",modelValue:l.downStart,"onUpdate:modelValue":e[8]||(e[8]=a=>l.downStart=a),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(d,{label:"점검 완료일",modelValue:l.doneAt,"onUpdate:modelValue":e[9]||(e[9]=a=>l.doneAt=a),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(d,{label:"다음 점검일",modelValue:l.nextAt,"onUpdate:modelValue":e[10]||(e[10]=a=>l.nextAt=a),type:"date",dense:"",outlined:""},null,8,["modelValue"]),D("div",Ve,[o(ue,{class:"mb-2 d-block"},{default:s(()=>e[13]||(e[13]=[y("적합 여부")])),_:1}),o(fe,{modelValue:l.fit,"onUpdate:modelValue":e[11]||(e[11]=a=>l.fit=a),inline:"",density:"compact"},{default:s(()=>[o(I,{label:"적합",value:"적합"}),o(I,{label:"부적합",value:"부적합"})]),_:1},8,["modelValue"])]),D("div",ye,[o(M,{color:"primary",onClick:q},{default:s(()=>e[14]||(e[14]=[y("점검완료")])),_:1})])]),_:1})]),_:1})]),_:1})):ie("",!0)]),_:1})],64))}};export{Fe as default};
