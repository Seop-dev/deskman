import{aK as Xe,O as g,y as p,aL as k,aM as M,a5 as Ze,_ as et,q as A,o as _,a as s,w as o,d as n,L as _e,f as N,e as f,t as c,aN as tt,aO as ye,V as be,b as y,W as V,S as W,aP as H,j as $,aQ as he,T as j,k as J,F as q,s as K,c as Y,a0 as w,E as at,$ as lt}from"./index-CGGVM91c.js";import{_ as st,a as ut}from"./UiParentCard.vue_vue_type_script_setup_true_lang-DnD-5gIF.js";import{_ as ot}from"./_plugin-vue_export-helper-DlAUqK2U.js";const nt={class:"wizard-head"},rt={class:"steps"},it={class:"actions"},dt={class:"prog-wrap"},ct={class:"prog-text"},vt={key:0,class:"picked-box"},pt={class:"picked-line truncate"},ft={key:1,class:"mt-2"},mt={class:"prog-wrap"},gt={class:"prog-text"},_t={class:"mt-3"},yt={class:"grid-btns workers-scroll"},bt={class:"bold"},ht={class:"muted small"},kt={class:"mt-3"},Ct={class:"grid-btns procs-grid"},At={class:"bold"},wt={class:"muted small"},Pt={class:"muted"},St={key:0,class:"muted"},It={class:"summary-bar"},Nt={class:"sum-left"},Et={key:0},Rt={key:1,class:"muted"},Ot={key:2,class:"muted"},xt={class:"sum-right"},Lt={class:"bottom-row"},Tt={class:"keypad"},Mt={class:"keypad-screen"},Vt={class:"keys"},$t=["onClick"],qt={class:"muted small mt-1"},Qt={class:"ctrl-btns"},Dt={__name:"ProcessControl",setup(Ut){var me,ge;const ke=((ge=(me=import.meta)==null?void 0:me.env)==null?void 0:ge.VITE_API_URL)||"http://localhost:3000",P=Xe(),Ce=g({title:"공정 진행관리"}),Ae=g([{title:"생산",disabled:!0,href:"#"},{title:"공정 진행관리",disabled:!1,href:"#"}]),m=g(1),we=()=>{m.value>1&&m.value--},Pe=()=>{if(m.value===1){if(!u.value)return alert("지시를 선택하세요.");if(!C.value)return alert("작업자를 선택하세요.");if(!i.value)return alert("공정을 선택하세요.");if(!v.value)return alert("설비를 선택하세요.");m.value=2}else u.value=null,C.value=null,i.value=null,v.value=null,b.value=0,S.value={startAt:"",endAt:""},m.value=1},G=p(()=>P.orders??[]),Se=p(()=>P.workers),X=g(1),u=g(null),C=g(null),i=g(null),v=g(null),Z=g(new Map),ee=(a,e)=>`${a}:${e}`,te=(a,e,t)=>{!a||!e||!t||Z.value.set(ee(a,e),String(t))},ae=(a,e)=>Z.value.get(ee(a,e))||null,E=g([]),le={"PRC-001":"CUT","PRC-002":"FAB","PRC-003":"POL","PRC-004":"PAI","PRC-005":"ASM"},Ie={CUT:"PRC-001",FAB:"PRC-002",POL:"PRC-003",PAI:"PRC-004",ASM:"PRC-005"};async function se(a=""){var r;const e=Ie[a]||"";if(!e){E.value=[];return}const t=await lt.get(`${ke}/api/facilities`,{params:{process:e}}).catch(()=>({data:null})),l=((r=t==null?void 0:t.data)==null?void 0:r.rows)||[];E.value=l.map(d=>({id:String(d.id??d.facId??d.code),code:String(d.code??d.facId),name:d.name,process:le[d.process]||le[d.prId]||a,status:d.status||k.AVAILABLE}))}const Ne=p(()=>{var t;const a=new Set,e=i.value;if(!e)return a;for(const l of G.value){const r=(t=l==null?void 0:l.processes)==null?void 0:t[e];(r==null?void 0:r.status)==="RUN"&&Array.isArray(r.equipIds)&&r.equipIds.forEach(d=>a.add(String(d)))}return a}),Ee=[{title:"지시번호",value:"issueNumber",width:160},{title:"제품명",value:"productName",width:220},{title:"유형",value:"productType",width:90},{title:"상태",value:"stateCol",sortable:!1,width:110},{title:"진행률",value:"progressCol",sortable:!1,width:140,align:"end"},{title:"선택",value:"pick",sortable:!1,width:80,align:"end"}],Re=[{title:"Id",value:"id",width:90},{title:"Name",value:"name",width:160},{title:"Status",value:"status",sortable:!1,width:100},{title:"선택",value:"pick",sortable:!1,width:80,align:"end"}],x=p(()=>v.value&&E.value.find(a=>a.id===v.value)||null),Oe=p(()=>{const a=i.value;return E.value.filter(e=>e.process===a).map(e=>{const t={...e};return Ne.value.has(String(e.id))&&t.status!==k.MAINT&&(t.status=k.IN_USE),t})}),ue=a=>a===k.AVAILABLE?"사용가능":a===k.IN_USE?"생산중":a===k.MAINT?"점검중":a,xe=a=>a===k.AVAILABLE?"success":a===k.IN_USE?"warning":"grey",Le=a=>{if(!u.value||!i.value)return!1;const e=ae(u.value.id,i.value);return String(e||"")===String(a||"")},oe=a=>a.status===k.AVAILABLE||Le(a.id),Te=a=>v.value===a.id?"primary":void 0;function Me(a){if(!oe(a))return alert(`다른 지시에서 사용 중인 설비입니다. (${ue(a.status)})`);v.value=a.id,u.value&&i.value&&te(u.value.id,i.value,a.id)}const Q=["CUT","FAB","POL","PAI","ASM"],D=a=>{var e;return((e=M.find(t=>t.code===a))==null?void 0:e.name)||a};function Ve(){if(!u.value)return[];const a=u.value.productType==="반제품";return Q.filter(e=>!(a&&e==="ASM"))}function U(a){const e=Ve(),t=e.indexOf(a);return t<=0?null:e[t-1]}function ne(a){var l,r,d;const e=U(a);return e?((d=(r=(l=u.value)==null?void 0:l.processes)==null?void 0:r[e])==null?void 0:d.status)==="DONE":!0}function $e(a){if(!u.value){i.value=a;return}if(!ne(a)){const e=U(a);alert(`이전공정을 완료해주세요. (${D(e)})`);return}i.value=a}function re(a){if(!a||!a.processes)return"N/A";const e=a.productType==="반제품",t=Q.filter(r=>!(e&&r==="ASM")),l=t.map(r=>{var d,h;return((h=(d=a.processes)==null?void 0:d[r])==null?void 0:h.status)||"IDLE"});if(l.length&&l.every(r=>r==="DONE"))return"생산완료";if(l.some(r=>r==="RUN"))return"생산중";for(let r=l.length-1;r>=0;r--)if(l[r]==="DONE")return`${D(t[r])}완료`;return"생산대기"}const qe=a=>a==="생산중"?"primary":a==="생산완료"||/완료$/.test(a)?"success":"grey",ie=a=>{const e=Object.values(a.processes||{});return e.length?Math.round(e.reduce((t,l)=>t+((l==null?void 0:l.progress)||0),0)/e.length):0};function Qe(a){u.value=a,C.value=null,i.value=null,v.value=null}const De=p(()=>{var a,e;return(e=(a=u.value)==null?void 0:a.processes)==null?void 0:e[i.value]}),Ue=[{title:"공정",value:"name",width:90},{title:"생산량",value:"qty",align:"end",width:120},{title:"진행률",value:"progress",align:"end",sortable:!1,width:140},{title:"상태",value:"state",align:"end",sortable:!1,width:100}],Be=p(()=>{if(!u.value)return[];const a=u.value.productType==="반제품";return M.filter(e=>!(a&&e.code==="ASM"))}),R=p(()=>{var a;return((a=M.find(e=>e.code===i.value))==null?void 0:a.name)||"-"}),de=p(()=>{if(!u.value)return[];const a=u.value.productType==="반제품";return Q.filter(e=>!(a&&e==="ASM"))}),Fe=(a,e)=>{var t,l;return((l=(t=a==null?void 0:a.processes)==null?void 0:t[e])==null?void 0:l.prodQty)??0},B=p(()=>{if(!u.value)return 0;const a=de.value;if(!a.length)return 0;const e=a.map(t=>Fe(u.value,t));return Math.max(0,Math.min(Math.min(...e),u.value.targetQty))}),F=p(()=>u.value?Math.max(0,u.value.targetQty-B.value):0),L=p(()=>{var a,e;return((e=(a=u.value)==null?void 0:a.processes)==null?void 0:e[i.value])||null}),ze=p(()=>{var a;return((a=L.value)==null?void 0:a.prodQty)??0}),ce=p(()=>{var a;return u.value?Math.max(0,u.value.targetQty-(((a=L.value)==null?void 0:a.prodQty)??0)):0}),z=p(()=>Math.min(F.value,ce.value)),We=p(()=>u.value?de.value.map(e=>{const t=M.find(T=>T.code===e),l=u.value.processes[e],r=(l==null?void 0:l.prodQty)??0,d=(l==null?void 0:l.progress)??0,h=(t==null?void 0:t.name)||e;let I;return(l==null?void 0:l.status)==="RUN"?I="생산중":(l==null?void 0:l.status)==="IDLE"?I="생산대기":(l==null?void 0:l.status)==="DONE"?I=`${h}완료`:I="준비",{code:e,name:h,qty:`${r} / ${u.value.targetQty}`,progress:d,state:(l==null?void 0:l.status)||"WAIT",stateLabel:I}}):[]);function ve(a){return a==="RUN"?"primary":a==="DONE"?"success":"grey"}function He(a){if(a==="RUN")return"생산중";if(a==="IDLE")return"생산대기";if(a==="DONE"){const e=((R==null?void 0:R.value)||"").trim();return e?`${e}완료`:"완료"}return"준비"}const b=g(0),S=g({startAt:"",endAt:""}),O=g(!1);function pe(a){const e=Number(String(b.value)+String(a));b.value=Math.min(e,z.value)}const je=()=>b.value=0,Je=()=>b.value=Math.min(b.value,z.value);function fe(){const a=new Date,e=t=>String(t).padStart(2,"0");return`${a.getFullYear()}-${e(a.getMonth()+1)}-${e(a.getDate())}T${e(a.getHours())}:${e(a.getMinutes())}`}Ze(i,async a=>{var r,d;b.value=0,S.value={startAt:"",endAt:""},await se(a||"");const e=u.value?ae(u.value.id,a):null,t=((d=(r=De.value)==null?void 0:r.equipIds)==null?void 0:d[0])||null,l=e||t||null;v.value=E.value.some(h=>String(h.id)===String(l))?l:null});async function Ke(){if(!u.value||!i.value||!C.value)return;if(!ne(i.value)){const r=U(i.value);return alert(`이전공정을 완료해주세요. (${D(r)})`)}if(!v.value)return alert("설비를 선택하세요.");if(b.value<=0)return alert("투입량을 입력하세요.");const a=fe();S.value.startAt=a,S.value.endAt="";const e=await P.startJob({orderId:Number(u.value.id),process:i.value,workerId:C.value.id,equipIds:[v.value],inputQty:Number(b.value)||0,startAt:a});if(!(e!=null&&e.ok))return alert((e==null?void 0:e.msg)||"작업 시작 실패");S.value.startAt=(e.startedAt||a).replace(" ","T").slice(0,16);const t=u.value.processes[i.value]??(u.value.processes[i.value]={});t.status="RUN",t.progress=Math.min(99,t.progress??0),t.equipIds=[v.value],te(u.value.id,i.value,v.value);const l=E.value.find(r=>r.id===v.value);l&&(l.status=k.IN_USE),alert("작업이 시작되었습니다.")}async function Ye(){var a;if(!O.value){O.value=!0;try{if(!u.value)return alert("지시가 선택되지 않았습니다.");if(!i.value)return alert("공정이 선택되지 않았습니다.");if(!v.value)return alert("설비가 선택되지 않았습니다.");const e=fe(),t=await P.finishJob({orderId:Number(u.value.id),process:i.value,workerId:((a=C.value)==null?void 0:a.id)??null,equipIds:[v.value],startAt:S.value.startAt||null,endAt:e,inputQty:Number(b.value)||0});if(!(t!=null&&t.ok))return alert((t==null?void 0:t.msg)||"작업종료 실패");S.value.endAt=(t.endedAt||e).replace(" ","T").slice(0,16);const l=u.value.processes[i.value]??(u.value.processes[i.value]={});typeof t.prodQty=="number"&&(l.prodQty=t.prodQty),typeof t.progress=="number"&&(l.progress=t.progress),l.status=l.progress>=100?"DONE":"IDLE";const r=E.value.find(d=>d.id===v.value);if(r&&(r.status=k.AVAILABLE),await se(i.value),b.value=0,alert("작업이 종료되었습니다."),t.allDone&&alert("이 지시의 모든 공정이 완료되어 품질검사 대기 큐에 적재되었습니다."),P.loadOrders){await P.loadOrders({page:1,size:100});const d=P.orders.find(h=>Number(h.id)===Number(u.value.id));d&&(u.value=d)}}finally{O.value=!1}}}const Ge=p(()=>m.value===1?!!(u.value&&C.value&&i.value&&v.value):!0);return et(async()=>{await Promise.all([P.loadOrders({page:1,size:100}),P.loadWorkers()])}),(a,e)=>(_(),A(q,null,[s(st,{title:Ce.value.title,breadcrumbs:Ae.value},null,8,["title","breadcrumbs"]),s(ut,{class:"pc-wrap"},{default:o(()=>[n("div",nt,[n("div",rt,[n("div",{class:_e(["step",{active:m.value===1,done:m.value>1}])},"1. 지시/작업자/공정/설비",2),e[3]||(e[3]=n("div",{class:"sep"},null,-1)),n("div",{class:_e(["step",{active:m.value===2}])},"2. 진행제어",2)]),n("div",it,[s(N,{class:"btn-sm",variant:"tonal",disabled:m.value===1,onClick:we},{default:o(()=>e[4]||(e[4]=[f("이전")])),_:1},8,["disabled"]),s(N,{class:"btn-sm",color:"primary",disabled:!Ge.value,onClick:Pe},{default:o(()=>[f(c(m.value<2?"다음":"초기화면"),1)]),_:1},8,["disabled"])])]),s(tt,{modelValue:m.value,"onUpdate:modelValue":e[2]||(e[2]=t=>m.value=t),class:"mt-1"},{default:o(()=>[s(ye,{value:1},{default:o(()=>[s(be,{dense:""},{default:o(()=>[s(y,{cols:"12"},{default:o(()=>[s(V,{variant:"outlined",class:"tight"},{default:o(()=>[s(W,{class:"tight-title"},{default:o(()=>e[5]||(e[5]=[f("지시목록")])),_:1}),s(H,{class:"no-hover table-fixed",density:"compact",headers:Ee,items:G.value,"item-key":"id","fixed-header":"",height:"300","items-per-page":5,"items-per-page-options":[5],page:X.value,"onUpdate:page":e[0]||(e[0]=t=>X.value=t)},{"item.progressCol":o(({item:t})=>[n("div",dt,[s(he,{"model-value":ie((t==null?void 0:t.raw)??t),height:"8"},null,8,["model-value"]),n("span",ct,c(ie((t==null?void 0:t.raw)??t))+"%",1)])]),"item.stateCol":o(({item:t})=>[s($,{size:"small",color:qe(re((t==null?void 0:t.raw)??t)),variant:"tonal"},{default:o(()=>[f(c(re((t==null?void 0:t.raw)??t)),1)]),_:2},1032,["color"])]),"item.pick":o(({item:t})=>{var l,r,d,h;return[s(N,{class:"btn-xs",variant:((l=u.value)==null?void 0:l.id)===(((r=t==null?void 0:t.raw)==null?void 0:r.id)??t.id)?"elevated":"tonal",color:((d=u.value)==null?void 0:d.id)===(((h=t==null?void 0:t.raw)==null?void 0:h.id)??t.id)?"primary":void 0,onClick:I=>Qe((t==null?void 0:t.raw)??t)},{default:o(()=>{var I,T;return[f(c(((I=u.value)==null?void 0:I.id)===(((T=t==null?void 0:t.raw)==null?void 0:T.id)??t.id)?"선택됨":"선택"),1)]}),_:2},1032,["variant","color","onClick"])]}),_:2},1032,["items","page"])]),_:1})]),_:1}),s(y,{cols:"12",md:"6"},{default:o(()=>[s(V,{variant:"outlined",class:"tight h-fixed"},{default:o(()=>[s(W,{class:"tight-title"},{default:o(()=>e[6]||(e[6]=[f("작업자 & 공정 선택")])),_:1}),s(j,{class:"tight-body"},{default:o(()=>[u.value?(_(),A("div",vt,[n("div",pt,[e[7]||(e[7]=n("span",{class:"muted"},"지시번호",-1)),e[8]||(e[8]=f()),n("b",null,c(u.value.issueNumber),1),e[9]||(e[9]=n("span",{class:"divider"},"|",-1)),e[10]||(e[10]=n("span",{class:"muted"},"제품",-1)),f(" "+c(u.value.productName)+" ("+c(u.value.productType)+") ",1),e[11]||(e[11]=n("span",{class:"divider"},"|",-1)),e[12]||(e[12]=n("span",{class:"muted"},"목표/기생산/미생산",-1)),n("b",null,c(u.value.targetQty),1),f(" / "+c(B.value)+" / "+c(F.value),1)])])):J("",!0),u.value?(_(),A("div",ft,[e[13]||(e[13]=n("div",{class:"label mb-1"},"공정별 생산량",-1)),s(H,{class:"no-hover no-scroll",headers:Ue,items:We.value,density:"compact","items-per-page":5,"items-per-page-options":[5],"hide-default-footer":""},{"item.progress":o(({item:t})=>[n("div",mt,[s(he,{"model-value":t.progress,height:"6"},null,8,["model-value"]),n("span",gt,c(t.progress)+"%",1)])]),"item.state":o(({item:t})=>[s($,{size:"small",color:ve(t.state),variant:"tonal"},{default:o(()=>[f(c(t.stateLabel),1)]),_:2},1032,["color"])]),_:2},1032,["items"])])):J("",!0),n("div",_t,[e[14]||(e[14]=n("div",{class:"label"},"작업자 선택",-1)),n("div",yt,[(_(!0),A(q,null,K(Se.value,t=>{var l;return _(),Y(N,{key:t.id,class:"grid-btn btn-sm",color:((l=C.value)==null?void 0:l.id)===t.id?"primary":void 0,onClick:r=>C.value=t},{default:o(()=>[n("div",bt,c(t.name),1),n("div",ht,c(t.id),1)]),_:2},1032,["color","onClick"])}),128))])]),n("div",kt,[e[15]||(e[15]=n("div",{class:"label"},"공정 선택",-1)),n("div",Ct,[(_(!0),A(q,null,K(Be.value,t=>(_(),Y(N,{key:t.code,class:"grid-btn btn-sm",color:i.value===t.code?"primary":void 0,onClick:l=>$e(t.code)},{default:o(()=>[n("div",At,c(t.name),1),n("div",wt,c(t.code),1)]),_:2},1032,["color","onClick"]))),128))])])]),_:1})]),_:1})]),_:1}),s(y,{cols:"12",md:"6"},{default:o(()=>[s(V,{variant:"outlined",class:"tight h-fixed"},{default:o(()=>[s(W,{class:"tight-title"},{default:o(()=>[e[16]||(e[16]=f(" 설비 선택 ")),n("small",Pt," — "+c(R.value),1)]),_:1}),s(j,{class:"tight-body"},{default:o(()=>[i.value?(_(),Y(H,{key:1,class:"no-hover table-fixed",headers:Re,items:Oe.value,density:"compact","item-key":"id","fixed-header":"",height:"240","items-per-page":5,"items-per-page-options":[5],"hide-default-footer":""},{"item.status":o(({item:t})=>[s($,{size:"small",color:xe(t.status),variant:"tonal"},{default:o(()=>[f(c(ue(t.status)),1)]),_:2},1032,["color"])]),"item.pick":o(({item:t})=>[s(N,{class:"btn-xs",variant:v.value===t.id?"elevated":"tonal",color:Te(t),disabled:!oe(t),onClick:l=>Me(t)},{default:o(()=>[f(c(v.value===t.id?"선택됨":"선택"),1)]),_:2},1032,["variant","color","disabled","onClick"])]),_:2},1032,["items"])):(_(),A("div",St,"공정을 먼저 선택하세요."))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(ye,{value:2},{default:o(()=>{var t;return[n("div",It,[n("div",Nt,[e[17]||(e[17]=n("span",{class:"muted"},"선택 설비",-1)),x.value?(_(),A("b",Et,c(x.value.name),1)):J("",!0),x.value?(_(),A("span",Rt,"("+c(x.value.code)+")",1)):(_(),A("span",Ot,"없음"))]),n("div",xt,[e[18]||(e[18]=n("span",{class:"muted"},"현재 공정 상태",-1)),s($,{size:"small",color:ve((t=L.value)==null?void 0:t.status),variant:"tonal",class:"ml-2"},{default:o(()=>{var l;return[f(c(He((l=L.value)==null?void 0:l.status)),1)]}),_:1},8,["color"])])]),s(V,{variant:"outlined",class:"tight"},{default:o(()=>[s(j,{class:"tight-body"},{default:o(()=>[s(be,{dense:"",class:"form-grid-fixed"},{default:o(()=>[s(y,{cols:"6"},{default:o(()=>{var l;return[s(w,{label:"지시번호","model-value":(l=u.value)==null?void 0:l.issueNumber,readonly:"",variant:"outlined"},null,8,["model-value"])]}),_:1}),s(y,{cols:"6"},{default:o(()=>[s(w,{label:"공정","model-value":R.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(y,{cols:"6"},{default:o(()=>{var l;return[s(w,{label:"목표수량","model-value":(l=u.value)==null?void 0:l.targetQty,readonly:"",variant:"outlined"},null,8,["model-value"])]}),_:1}),s(y,{cols:"6"},{default:o(()=>[s(w,{label:"기생산량(전체)","model-value":B.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(y,{cols:"6"},{default:o(()=>[s(w,{label:"미생산량(전체)","model-value":F.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(y,{cols:"6"},{default:o(()=>{var l;return[s(w,{label:"작업자","model-value":(l=C.value)==null?void 0:l.name,readonly:"",variant:"outlined"},null,8,["model-value"])]}),_:1}),s(y,{cols:"6"},{default:o(()=>[s(w,{label:"해당 공정 생산량","model-value":ze.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(y,{cols:"6"},{default:o(()=>[s(w,{label:"해당 공정 미생산량","model-value":ce.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(y,{cols:"6"},{default:o(()=>[s(w,{label:"시작일시","model-value":S.value.startAt,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(y,{cols:"6"},{default:o(()=>[s(w,{label:"종료일시","model-value":S.value.endAt,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1})]),_:1}),n("div",Lt,[n("div",Tt,[n("div",Mt,c(b.value),1),n("div",Vt,[(_(),A(q,null,K([1,2,3,4,5,6,7,8,9],l=>n("button",{key:l,onClick:r=>pe(l)},c(l),9,$t)),64)),n("button",{onClick:je},"C"),n("button",{onClick:e[1]||(e[1]=l=>pe(0))},"0"),n("button",{onClick:Je},"✔")]),n("div",qt,"허용 상한: "+c(z.value),1)]),n("div",Qt,[s(N,{class:"btn-md mr-2",color:"primary",onClick:Ke},{default:o(()=>e[19]||(e[19]=[f("작업시작")])),_:1}),s(N,{class:"btn-md",color:"error",loading:O.value,disabled:O.value,onClick:at(Ye,["stop","prevent"])},{default:o(()=>e[20]||(e[20]=[f(" 작업종료 ")])),_:1},8,["loading","disabled"])])])]),_:1})]),_:1})]}),_:1})]),_:1},8,["modelValue"])]),_:1})],64))}},Wt=ot(Dt,[["__scopeId","data-v-a3e99084"]]);export{Wt as default};
