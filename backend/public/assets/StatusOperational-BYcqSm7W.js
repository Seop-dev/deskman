import{aU as ce,aV as me,O as r,a6 as pe,P as _e,q as Y,o as T,a as o,w as s,c as $,k as Se,V as R,b as y,f as C,e as m,a0 as p,A as I,a1 as ge,d as we,aT as E,a3 as D,a4 as S,F as k,s as Te,W as ye,$ as u}from"./index-CGGVM91c.js";import{_ as Ae,a as Re}from"./UiParentCard.vue_vue_type_script_setup_true_lang-DnD-5gIF.js";import{_ as Ce}from"./NewModal-RG6-e5WE.js";import{B as Ee}from"./main-Dfa23GB-.js";import{d as De}from"./theme-bootstrap-maRaUoWN.js";const Fe={class:"text-right mt-2"},f="http://localhost:3000",xe={__name:"StatusOperational",setup(be){const c=De.useToast();ce.registerModules([me]);const O=ge,U=`${f}/process`;let g=new Map,F=new Map;const b=r([]),B=async()=>{const[t,e]=await Promise.all([u.get(`${f}/common/codes/FC`),u.get(`${f}/common/codes/RR`)]),l=n=>{const i=new Map;for(const d of n||[])i.set(String(d.code??d.CODE),d.code_name??d.CODE_NAME);return i};g=l(t.data),F=l(e.data),b.value=Array.isArray(e.data)?e.data:[]},_=r(""),w=r(null),W=async t=>{w.value=t.api,await A()},V=t=>{w.value&&(w.value.setFilterModel({공정코드:{filterType:"text",type:"equals",filter:t||""}}),w.value.onFilterChanged())},h={editable:!1,sortable:!0,resizable:!0,suppressHeaderMenuButton:!0},G=t=>t==="가동"?{color:"blue",fontWeight:"bold"}:t==="비가동"?{color:"red",fontWeight:"bold"}:null,z=r([{field:"공정코드",hide:!0,filter:"agTextColumnFilter"},{field:"설비코드",flex:1},{field:"설비명",flex:1},{field:"설비유형",flex:1},{field:"설비상태",flex:1,cellStyle:t=>G(t.value)},{field:"비가동사유",flex:1},{field:"고장유형",flex:1},{field:"비가동시작시간",flex:1}]),P=r([]),H=async()=>(await u.get(`${f}/facility`)).data||[],q=async()=>(await u.get(`${f}/facility/status`)).data||[],L=t=>{if(!t)return"";const e=new Date(t),l=n=>String(n).padStart(2,"0");return`${e.getFullYear()}-${l(e.getMonth()+1)}-${l(e.getDate())} ${l(e.getHours())}:${l(e.getMinutes())}:${l(e.getSeconds())}`},K=t=>({0:"가동",1:"비가동",2:"점검중"})[Number(t)]??String(t),X=(t,e)=>{const l=new Map(e.map(n=>[n.FAC_ID,n]));return(t||[]).map(n=>{const i=l.get(n.FAC_ID)||{},d=Number(n.FS_STATUS??0),de=K(d),re=d===1&&n.FS_REASON||"-",ie=d===1&&n.FS_TYPE?F.get(String(n.FS_TYPE))||n.FS_TYPE:"-",ue=d===1&&n.DOWN_STARTDAY?L(n.DOWN_STARTDAY):"-",fe=i.FAC_TYPE?g.get(String(i.FAC_TYPE))||i.FAC_TYPE:i.FAC_TYPE_NM||"-";return{공정코드:i.PR_ID||"",설비코드:n.FAC_ID,설비명:n.FAC_NAME||i.FAC_NAME||"",설비유형:fe,설비상태:de,비가동사유:re,고장유형:ie,비가동시작시간:ue,_fsId:n.FS_ID||null,_fsStatus:d,_downEnd:n.DOWN_ENDDAY||null,_fsType:n.FS_TYPE||null}})},Q=t=>(t||[]).map(e=>({공정코드:e.PR_ID||"",설비코드:e.FAC_ID,설비명:e.FAC_NAME||"",설비유형:e.FAC_TYPE?g.get(String(e.FAC_TYPE))||e.FAC_TYPE:"-",설비상태:"가동",비가동사유:"-",고장유형:"-",비가동시작시간:"-",담당자:e.MANAGER||"-",_fsId:null,_fsStatus:0,_downEnd:null,_fsType:null})),A=async()=>{await B();const[t,e]=await Promise.all([H(),q()]);P.value=e.length>0?X(e,t):Q(t),_.value&&V(_.value)},a=pe({code:"",name:"",type:"",targetStatus:"비가동",downReason:"",errType:"",downStart:"",downEnd:"",manager:"-",_fsId:null,_downEnd:null,_fsStatus:0,_fsType:null}),j=t=>{const e=t.data,l=e.설비상태==="가동";a.code=e.설비코드,a.name=e.설비명,a.type=e.설비유형,a.targetStatus=l?"비가동":"가동",a.downReason=l?"":e.비가동사유!=="-"?e.비가동사유:"",a.errType=l?"":t.data._fsType||"",a.downStart=l?"":e.비가동시작시간!=="-"?e.비가동시작시간:"",a.downEnd="",a._fsId=t.data._fsId||null,a._fsStatus=t.data._fsStatus||0},J=async()=>{if(a.targetStatus!=="비가동"||!a.code)return;if(!a.downReason){c.error("비가동 사유를 선택하세요.",{position:"top-right",duration:1e3});return}if(a.downReason==="고장"&&!a.errType){c.error("고장 유형을 선택하세요.",{position:"top-right",duration:1e3});return}const t=v();try{a._fsId?await u.patch(`${f}/facility/status/down`,{FS_ID:a._fsId,FS_STATUS:1,FS_REASON:a.downReason,FS_TYPE:a.downReason==="고장"?a.errType:null,DOWN_STARTDAY:t,FS_CHECKDAY:t,FS_NEXTDAY:null,MANAGER:a.manager||"-"}):await u.post(`${f}/facility/status`,{FAC_ID:a.code,FS_STATUS:1,FS_REASON:a.downReason,FS_TYPE:a.downReason==="고장"?a.errType:null,DOWN_STARTDAY:t,FS_CHECKDAY:t,FS_NEXTDAY:null,MANAGER:a.manager||"-"}),a.downStart=t,a.downEnd="",await A(),c.success("비가동 처리되었습니다.",{position:"top-right",duration:1e3})}catch(e){console.error(e),c.error("비가동 처리 중 오류가 발생했습니다.",{position:"top-right",duration:1e3})}},Z=async()=>{if(a.targetStatus!=="가동"||!a.code)return;const t=a._fsId,e=v();try{t&&await u.patch(`${f}/facility/status/end`,{FS_ID:t,endTime:e,restoreStatus:0,checkTime:e}),a.downEnd=e,await A(),a.downReason="",a.errType="",a.downStart="",c.success("가동으로 전환되었습니다.",{position:"top-right",duration:1e3})}catch(l){console.error(l),c.error("가동 처리 중 오류가 발생했습니다.",{position:"top-right",duration:1e3})}};function v(){const t=new Date,e=l=>String(l).padStart(2,"0");return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}:${e(t.getSeconds())}`}const N=r(null),M=r(""),x=r([]),ee=r([{field:"공정코드",flex:1},{field:"공정명",flex:1},{field:"설비유형",flex:1},{field:"등록일자",flex:1},{field:"작성자",flex:1},{field:"비고",flex:1}]),te=t=>({공정코드:t.PR_ID??t.PRC_CODE??"",공정명:t.PRC_NAME??"",설비유형:t.FAC_TYPE?g.get(String(t.FAC_TYPE))||t.FAC_TYPE:"-",등록일자:(typeof t.PRC_RDATE=="string"?t.PRC_RDATE.slice(0,10):"")||"",작성자:t.PRC_WRITER??"",비고:t.PRC_NOTE??""}),ae=async()=>(await u.get(U)).data.map(te),le=async t=>{var e;try{M.value=t,x.value=await ae(),(e=N.value)==null||e.open()}catch(l){console.error("[process list] error:",l),c.error("공정 목록 조회 실패",{position:"top-right",duration:1e3})}},oe=t=>{t&&(_.value=t.공정코드||"",V(t.공정코드))},ne=r({title:"설비 상태 관리"}),se=_e([{title:"설비",disabled:!0,href:"#"},{title:"비가동 관리",disabled:!1,href:"#"}]);return(t,e)=>(T(),Y(k,null,[o(Ae,{title:ne.value.title,breadcrumbs:se.value},null,8,["title","breadcrumbs"]),o(Re,{title:"비가동 관리"},{default:s(()=>[o(R,{class:"mb-2 py-0"},{default:s(()=>[o(y,{cols:"12",class:"d-flex align-center"},{default:s(()=>[o(C,{color:"warning",variant:"flat",onClick:e[0]||(e[0]=l=>le("공정 조회"))},{default:s(()=>e[10]||(e[10]=[m(" 공정 조회 ")])),_:1})]),_:1})]),_:1}),o(R,{class:"mb-4 pt-0"},{default:s(()=>[o(y,{cols:"12",md:"3"},{default:s(()=>[o(p,{label:"공정코드",modelValue:_.value,"onUpdate:modelValue":e[1]||(e[1]=l=>_.value=l),readonly:"","hide-details":"",density:"comfortable",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),o(I(Ee),{class:"ag-theme-quartz grid-clean",style:{height:"260px"},theme:I(O),rowData:P.value,columnDefs:z.value,defaultColDef:h,animateRows:!0,suppressClickEdit:!0,pagination:!0,"pagination-page-size":10,onGridReady:W,onRowClicked:j},null,8,["theme","rowData","columnDefs"]),a.code?(T(),$(ye,{key:0,class:"mt-6 pa-4"},{default:s(()=>[o(R,{dense:""},{default:s(()=>[o(y,{cols:"12",md:"6"},{default:s(()=>[o(p,{label:"설비코드",modelValue:a.code,"onUpdate:modelValue":e[2]||(e[2]=l=>a.code=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(p,{label:"설비명",modelValue:a.name,"onUpdate:modelValue":e[3]||(e[3]=l=>a.name=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(p,{label:"설비유형",modelValue:a.type,"onUpdate:modelValue":e[4]||(e[4]=l=>a.type=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(p,{label:"비가동 시작일시",modelValue:a.downStart,"onUpdate:modelValue":e[5]||(e[5]=l=>a.downStart=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(p,{class:"mt-2",label:"비가동 완료일시",modelValue:a.downEnd,"onUpdate:modelValue":e[6]||(e[6]=l=>a.downEnd=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"])]),_:1}),o(y,{cols:"12",md:"6"},{default:s(()=>[o(E,{class:"mb-1 d-block"},{default:s(()=>e[11]||(e[11]=[m("상태 선택")])),_:1}),o(D,{modelValue:a.targetStatus,"onUpdate:modelValue":e[7]||(e[7]=l=>a.targetStatus=l),inline:""},{default:s(()=>[o(S,{label:"가동",value:"가동"}),o(S,{label:"비가동",value:"비가동"})]),_:1},8,["modelValue"]),o(E,{class:"mb-1 d-block"},{default:s(()=>e[12]||(e[12]=[m("비가동 사유")])),_:1}),o(D,{modelValue:a.downReason,"onUpdate:modelValue":e[8]||(e[8]=l=>a.downReason=l),inline:"",disabled:a.targetStatus!=="비가동"},{default:s(()=>[o(S,{label:"고장",value:"고장"}),o(S,{label:"점검",value:"점검"})]),_:1},8,["modelValue","disabled"]),o(E,{class:"mb-1 d-block"},{default:s(()=>e[13]||(e[13]=[m("고장 유형")])),_:1}),o(D,{modelValue:a.errType,"onUpdate:modelValue":e[9]||(e[9]=l=>a.errType=l),inline:"",disabled:a.targetStatus!=="비가동"||a.downReason!=="고장"},{default:s(()=>[(T(!0),Y(k,null,Te(b.value,l=>(T(),$(S,{key:l.code,label:l.code_name,value:l.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),we("div",Fe,[o(C,{color:"error",disabled:a.targetStatus!=="비가동",onClick:J},{default:s(()=>e[14]||(e[14]=[m("비가동")])),_:1},8,["disabled"]),o(C,{class:"ml-2",color:"primary",disabled:a.targetStatus!=="가동",onClick:Z},{default:s(()=>e[15]||(e[15]=[m("가동")])),_:1},8,["disabled"])])]),_:1})]),_:1})]),_:1})):Se("",!0)]),_:1}),o(Ce,{ref_key:"modalRef",ref:N,title:M.value,rowData:x.value,colDefs:ee.value,onConfirm:oe},null,8,["title","rowData","colDefs"])],64))}};export{xe as default};
